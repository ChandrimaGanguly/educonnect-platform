# EduConnect Orchestrator - Phase & Group Configuration
# This file defines all phases and their execution groups
# Execution modes: sequential (default), parallel

orchestrator:
  name: "EduConnect Test Coverage & CI/CD Improvement"
  version: "1.0.0"
  project_root: ".."

  # Global settings
  settings:
    max_parallel_tasks: 4
    retry_attempts: 3
    retry_delay_seconds: 5
    timeout_minutes: 30
    fail_fast: false  # Continue other groups on failure
    notifications:
      on_phase_complete: true
      on_failure: true
      slack_webhook: "${SLACK_WEBHOOK_URL}"

# =============================================================================
# PHASE 1: Foundation & Quick Wins (Week 1)
# =============================================================================
phase_1:
  name: "Foundation & Quick Wins"
  description: "Unblock CI and establish foundation for systematic improvement"
  estimated_duration: "1 week"

  groups:
    # Group A: Fix Immediate CI Blockers - Run sequentially
    group_a:
      name: "Fix Immediate CI Blockers"
      execution: sequential
      tasks:
        - id: "1.1"
          name: "Expand Jest collectCoverageFrom"
          type: config_edit
          target: "jest.config.js"
          action: expand_coverage_collection
          description: "Include all testable code directories in coverage collection"

        - id: "1.2"
          name: "Add per-directory coverage thresholds"
          type: config_edit
          target: "jest.config.js"
          action: add_directory_thresholds
          thresholds:
            services: 70
            routes: 60
            utils: 80

        - id: "1.3"
          name: "Fix Python safety check"
          type: config_edit
          target: ".github/workflows/ci.yml"
          action: remove_continue_on_error
          description: "Remove --continue-on-error from safety check"

        - id: "1.4"
          name: "Add database migration to CI"
          type: config_edit
          target: ".github/workflows/ci.yml"
          action: add_migration_step
          description: "Add npm run migrate before test execution"

    # Group B: Test Infrastructure Setup - Can run in parallel
    group_b:
      name: "Test Infrastructure Setup"
      execution: parallel
      depends_on: ["group_a"]
      tasks:
        - id: "1.5"
          name: "Create shared test fixtures"
          type: file_generation
          target: "src/test/fixtures/"
          templates:
            - users.fixture.ts
            - communities.fixture.ts
            - assessments.fixture.ts

        - id: "1.6"
          name: "Add integration test helpers"
          type: file_generation
          target: "src/test/integration/"
          templates:
            - database.helper.ts
            - setup.ts

        - id: "1.7"
          name: "Create Python pytest fixtures"
          type: file_generation
          target: "python-services/"
          templates:
            - conftest.py
            - fixtures/common.py

# =============================================================================
# PHASE 2: Critical Service Coverage (Weeks 2-3)
# =============================================================================
phase_2:
  name: "Critical Service Coverage"
  description: "Target the highest-risk untested business logic"
  estimated_duration: "2 weeks"
  depends_on: ["phase_1"]

  groups:
    # Group C: Core Business Logic Tests - Run in parallel (independent services)
    group_c:
      name: "Core Business Logic Tests"
      execution: parallel
      max_parallel: 3
      tasks:
        - id: "2.1"
          name: "Test automated-scoring.service.ts"
          type: test_generation
          target: "src/services/automated-scoring.service.ts"
          test_file: "src/services/__tests__/automated-scoring.service.test.ts"
          priority: critical
          estimated_cases: 55

        - id: "2.2"
          name: "Test rbac.service.ts"
          type: test_generation
          target: "src/services/rbac.service.ts"
          test_file: "src/services/__tests__/rbac.service.test.ts"
          priority: critical
          estimated_cases: 40

        - id: "2.3"
          name: "Test trust.service.ts"
          type: test_generation
          target: "src/services/trust.service.ts"
          test_file: "src/services/__tests__/trust.service.test.ts"
          priority: critical
          estimated_cases: 35

        - id: "2.4"
          name: "Test community.service.ts"
          type: test_generation
          target: "src/services/community.service.ts"
          test_file: "src/services/__tests__/community.service.test.ts"
          priority: high
          estimated_cases: 40

        - id: "2.5"
          name: "Test sync-engine.service.ts"
          type: test_generation
          target: "src/services/sync-engine.service.ts"
          test_file: "src/services/__tests__/sync-engine.service.test.ts"
          priority: high
          estimated_cases: 35

        - id: "2.6"
          name: "Test checkpoint-types.service.ts"
          type: test_generation
          target: "src/services/checkpoint-types.service.ts"
          test_file: "src/services/__tests__/checkpoint-types.service.test.ts"
          priority: high
          estimated_cases: 45

    # Group D: Authentication & Security Tests - Sequential (security-sensitive)
    group_d:
      name: "Authentication & Security Tests"
      execution: sequential
      depends_on: ["group_c"]
      tasks:
        - id: "2.7"
          name: "Test auth routes"
          type: test_generation
          target: "src/routes/auth.ts"
          test_file: "src/routes/__tests__/auth.test.ts"
          priority: critical
          estimated_cases: 45

        - id: "2.8"
          name: "Test auth middleware"
          type: test_generation
          target: "src/middleware/auth.ts"
          test_file: "src/middleware/__tests__/auth.test.ts"
          priority: critical
          estimated_cases: 18

        - id: "2.9"
          name: "Test plugins configuration"
          type: test_generation
          target: "src/plugins/index.ts"
          test_file: "src/plugins/__tests__/index.test.ts"
          priority: high
          estimated_cases: 22

        - id: "2.10"
          name: "Test JWT utilities"
          type: test_generation
          target: "src/utils/jwt.ts"
          test_file: "src/utils/__tests__/jwt.test.ts"
          priority: high
          estimated_cases: 12

# =============================================================================
# PHASE 3: Route & Integration Coverage (Weeks 4-5)
# =============================================================================
phase_3:
  name: "Route & Integration Coverage"
  description: "Complete API endpoint testing"
  estimated_duration: "2 weeks"
  depends_on: ["phase_2"]

  groups:
    # Group E: Critical Route Tests - Parallel execution
    group_e:
      name: "Critical Route Tests"
      execution: parallel
      max_parallel: 3
      tasks:
        - id: "3.1"
          name: "Test content-review routes"
          type: test_generation
          target: "src/routes/content-review.ts"
          test_file: "src/routes/__tests__/content-review.test.ts"
          priority: critical
          estimated_cases: 50

        - id: "3.2"
          name: "Test checkpoint-scoring routes"
          type: test_generation
          target: "src/routes/checkpoint-scoring.ts"
          test_file: "src/routes/__tests__/checkpoint-scoring.test.ts"
          priority: critical
          estimated_cases: 35

        - id: "3.3"
          name: "Test content-authoring routes"
          type: test_generation
          target: "src/routes/content-authoring.ts"
          test_file: "src/routes/__tests__/content-authoring.test.ts"
          priority: high
          estimated_cases: 40

        - id: "3.4"
          name: "Test community-trust routes"
          type: test_generation
          target: "src/routes/community-trust.ts"
          test_file: "src/routes/__tests__/community-trust.test.ts"
          priority: high
          estimated_cases: 30

        - id: "3.5"
          name: "Test text-mode routes"
          type: test_generation
          target: "src/routes/text-mode.ts"
          test_file: "src/routes/__tests__/text-mode.test.ts"
          priority: high
          estimated_cases: 40

        - id: "3.6"
          name: "Test notifications routes"
          type: test_generation
          target: "src/routes/notifications.ts"
          test_file: "src/routes/__tests__/notifications.test.ts"
          priority: medium
          estimated_cases: 25

    # Group F: Service Gap Closure - Parallel
    group_f:
      name: "Service Gap Closure"
      execution: parallel
      max_parallel: 2
      tasks:
        - id: "3.7"
          name: "Test text-mode.service.ts"
          type: test_generation
          target: "src/services/text-mode.service.ts"
          test_file: "src/services/__tests__/text-mode.service.test.ts"
          priority: high
          estimated_cases: 35

        - id: "3.8"
          name: "Test content-transcoding.service.ts"
          type: test_generation
          target: "src/services/content-transcoding.service.ts"
          test_file: "src/services/__tests__/content-transcoding.service.test.ts"
          priority: high
          estimated_cases: 30

        - id: "3.9"
          name: "Test notifications.ts service"
          type: test_generation
          target: "src/services/notifications.ts"
          test_file: "src/services/__tests__/notifications.service.test.ts"
          priority: medium
          estimated_cases: 28

        - id: "3.10"
          name: "Test audit.ts service"
          type: test_generation
          target: "src/services/audit.ts"
          test_file: "src/services/__tests__/audit.service.test.ts"
          priority: medium
          estimated_cases: 20

# =============================================================================
# PHASE 4: CI/CD Pipeline Architecture (Weeks 3-4, runs parallel to Phase 2-3)
# =============================================================================
phase_4:
  name: "CI/CD Pipeline Architecture"
  description: "Fix deployment pipeline gaps"
  estimated_duration: "2 weeks"
  parallel_with: ["phase_2", "phase_3"]  # Can run alongside test coverage work

  groups:
    # Group G: Deployment Implementation - Sequential (critical, ordered)
    group_g:
      name: "Deployment Implementation"
      execution: sequential
      tasks:
        - id: "4.1"
          name: "Implement staging deployment"
          type: config_edit
          target: ".github/workflows/deploy.yml"
          action: implement_staging_deploy
          description: "Add actual Kubernetes/Helm deployment commands for staging"

        - id: "4.2"
          name: "Implement production deployment"
          type: config_edit
          target: ".github/workflows/deploy.yml"
          action: implement_production_deploy
          description: "Add actual Kubernetes/Helm deployment commands for production"

        - id: "4.3"
          name: "Add database migration to deploy"
          type: config_edit
          target: ".github/workflows/deploy.yml"
          action: add_deploy_migration
          description: "Run migrations before deploying new containers"

        - id: "4.4"
          name: "Configure GitHub secrets"
          type: manual
          description: "Configure KUBECONFIG, REGISTRY_PASSWORD, DB secrets in GitHub"
          requires_manual: true

        - id: "4.5"
          name: "Add production approval gates"
          type: config_edit
          target: ".github/workflows/deploy.yml"
          action: add_approval_gates
          description: "Require manual approval for production deployments"

    # Group H: Pipeline Quality Improvements - Parallel where possible
    group_h:
      name: "Pipeline Quality Improvements"
      execution: parallel
      depends_on: ["group_g"]
      max_parallel: 3
      tasks:
        - id: "4.6"
          name: "Add health check validation"
          type: config_edit
          target: ".github/workflows/deploy.yml"
          action: add_health_checks

        - id: "4.7"
          name: "Implement rollback automation"
          type: file_generation
          target: ".github/workflows/rollback.yml"
          templates:
            - rollback-workflow.yml

        - id: "4.8"
          name: "Add smoke tests"
          type: file_generation
          target: "tests/smoke/"
          templates:
            - smoke-tests.ts

        - id: "4.9"
          name: "Enable parallel Python builds"
          type: config_edit
          target: ".github/workflows/ci.yml"
          action: parallelize_python_builds

        - id: "4.10"
          name: "Add conditional test skipping"
          type: config_edit
          target: ".github/workflows/ci.yml"
          action: add_path_filters

    # Group I: Security & Compliance - Sequential
    group_i:
      name: "Security & Compliance"
      execution: sequential
      tasks:
        - id: "4.11"
          name: "Make Trivy scan blocking"
          type: config_edit
          target: ".github/workflows/ci.yml"
          action: make_trivy_blocking

        - id: "4.12"
          name: "Upgrade npm audit threshold"
          type: config_edit
          target: ".github/workflows/ci.yml"
          action: upgrade_audit_level

        - id: "4.13"
          name: "Add SBOM generation"
          type: config_edit
          target: ".github/workflows/deploy.yml"
          action: add_sbom_generation

        - id: "4.14"
          name: "Add container vulnerability scanning"
          type: config_edit
          target: ".github/workflows/deploy.yml"
          action: add_container_scanning

# =============================================================================
# PHASE 5: Extended Coverage (Weeks 6-7)
# =============================================================================
phase_5:
  name: "Extended Coverage"
  description: "Complete coverage across all layers"
  estimated_duration: "2 weeks"
  depends_on: ["phase_3"]

  groups:
    # Group J: Configuration & Infrastructure Tests
    group_j:
      name: "Configuration & Infrastructure Tests"
      execution: parallel
      max_parallel: 3
      tasks:
        - id: "5.1"
          name: "Test config/index.ts"
          type: test_generation
          target: "src/config/index.ts"
          test_file: "src/config/__tests__/index.test.ts"
          priority: high
          estimated_cases: 20

        - id: "5.2"
          name: "Test config/env.ts"
          type: test_generation
          target: "src/config/env.ts"
          test_file: "src/config/__tests__/env.test.ts"
          priority: high
          estimated_cases: 18

        - id: "5.3"
          name: "Test config/redis.ts"
          type: test_generation
          target: "src/config/redis.ts"
          test_file: "src/config/__tests__/redis.test.ts"
          priority: medium
          estimated_cases: 12

        - id: "5.4"
          name: "Test config/cache.ts"
          type: test_generation
          target: "src/config/cache.ts"
          test_file: "src/config/__tests__/cache.test.ts"
          priority: medium
          estimated_cases: 10

        - id: "5.5"
          name: "Test config/session.ts"
          type: test_generation
          target: "src/config/session.ts"
          test_file: "src/config/__tests__/session.test.ts"
          priority: medium
          estimated_cases: 10

    # Group K: GraphQL Tests
    group_k:
      name: "GraphQL Tests"
      execution: parallel
      max_parallel: 2
      tasks:
        - id: "5.6"
          name: "Test graphql/schema.ts"
          type: test_generation
          target: "src/graphql/schema.ts"
          test_file: "src/graphql/__tests__/schema.test.ts"
          priority: high
          estimated_cases: 25

        - id: "5.7"
          name: "Test graphql/resolvers.ts"
          type: test_generation
          target: "src/graphql/resolvers.ts"
          test_file: "src/graphql/__tests__/resolvers.test.ts"
          priority: high
          estimated_cases: 30

        - id: "5.8"
          name: "GraphQL integration tests"
          type: test_generation
          target: "src/graphql/"
          test_file: "src/graphql/__tests__/integration.test.ts"
          priority: medium
          estimated_cases: 20

    # Group L: Python Microservices Tests
    group_l:
      name: "Python Microservices Tests"
      execution: parallel
      max_parallel: 4
      tasks:
        - id: "5.9"
          name: "Test matching service"
          type: test_generation
          target: "python-services/matching/main.py"
          test_file: "python-services/matching/tests/test_main.py"
          language: python
          priority: high
          estimated_cases: 20

        - id: "5.10"
          name: "Test analytics service"
          type: test_generation
          target: "python-services/analytics/main.py"
          test_file: "python-services/analytics/tests/test_main.py"
          language: python
          priority: high
          estimated_cases: 18

        - id: "5.11"
          name: "Test moderation service"
          type: test_generation
          target: "python-services/moderation/main.py"
          test_file: "python-services/moderation/tests/test_main.py"
          language: python
          priority: high
          estimated_cases: 22

        - id: "5.12"
          name: "Test checkpoint service"
          type: test_generation
          target: "python-services/checkpoint/main.py"
          test_file: "python-services/checkpoint/tests/test_main.py"
          language: python
          priority: high
          estimated_cases: 20

# =============================================================================
# PHASE 6: Production Readiness (Week 8+)
# =============================================================================
phase_6:
  name: "Production Readiness"
  description: "Advanced deployment patterns and comprehensive testing"
  estimated_duration: "2+ weeks"
  depends_on: ["phase_4", "phase_5"]

  groups:
    # Group M: Deployment Strategies
    group_m:
      name: "Deployment Strategies"
      execution: sequential
      tasks:
        - id: "6.1"
          name: "Implement blue-green deployment"
          type: config_edit
          target: ".github/workflows/deploy.yml"
          action: add_blue_green
          description: "Zero-downtime deployment with blue-green strategy"

        - id: "6.2"
          name: "Add canary deployment option"
          type: config_edit
          target: ".github/workflows/deploy.yml"
          action: add_canary
          description: "Gradual rollout capability"

        - id: "6.3"
          name: "Create deployment runbooks"
          type: file_generation
          target: "docs/runbooks/"
          templates:
            - deployment.md
            - rollback.md
            - troubleshooting.md

        - id: "6.4"
          name: "Add performance regression detection"
          type: config_edit
          target: ".github/workflows/ci.yml"
          action: add_perf_checks

    # Group N: E2E & Load Testing
    group_n:
      name: "E2E & Load Testing"
      execution: sequential  # E2E tests should run in order
      tasks:
        - id: "6.5"
          name: "E2E: User registration flow"
          type: test_generation
          target: "tests/e2e/"
          test_file: "tests/e2e/registration.spec.ts"
          test_type: e2e
          priority: critical

        - id: "6.6"
          name: "E2E: Mentor matching flow"
          type: test_generation
          target: "tests/e2e/"
          test_file: "tests/e2e/mentor-matching.spec.ts"
          test_type: e2e
          priority: critical

        - id: "6.7"
          name: "E2E: Assessment completion"
          type: test_generation
          target: "tests/e2e/"
          test_file: "tests/e2e/assessment.spec.ts"
          test_type: e2e
          priority: critical

        - id: "6.8"
          name: "Load testing implementation"
          type: file_generation
          target: "tests/load/"
          templates:
            - k6-config.js
            - scenarios/api-load.js
            - scenarios/concurrent-users.js

# =============================================================================
# Validation Checkpoints
# =============================================================================
checkpoints:
  after_phase_1:
    name: "Foundation Complete"
    validations:
      - type: coverage_threshold
        target: 30
        description: "Baseline coverage established"
      - type: ci_passing
        description: "CI pipeline runs successfully"

  after_phase_3:
    name: "Coverage Target Met"
    validations:
      - type: coverage_threshold
        target: 60
        description: "60% coverage achieved"
      - type: all_critical_tested
        description: "All critical services have tests"

  after_phase_5:
    name: "80% Coverage Achieved"
    validations:
      - type: coverage_threshold
        target: 80
        description: "80% overall coverage"
      - type: python_coverage
        target: 70
        description: "Python services at 70%+"

  after_phase_6:
    name: "Production Ready"
    validations:
      - type: coverage_threshold
        target: 80
        description: "Maintained 80%+ coverage"
      - type: deployment_working
        description: "Staging and production deployments functional"
      - type: e2e_passing
        description: "All E2E tests passing"
